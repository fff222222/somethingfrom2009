<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <style>
            body,html{
                background: #fff;
                padding:0;
                margin:0;
                font-family: 微软雅黑;
            }
            body{
                width:990px;
                height:768px;
                margin:0 auto;
                position: relative;
            }
            .user{
                width:30px;
                height:30px;
                background:#ddd;
                border-radius:15px;
                border:1px solid #aaa;
                overflow: hidden;
                background-size: 100px 100px;
                box-shadow:1px 1px 3px #4797CF;
            }
            #circle_con{
                width:600px;
                height:600px;
                position:relative;
                float:left;
            }
            #circle_small{
                background:#4797CF;
                width:400px;
                height:400px;
                border-radius:200px;
                border:1px solid #3983B5;
                top:100px;
                left:100px;
                position: absolute;
            }
            #circle_big{
                position: absolute;
                left:0;
                top:0;
                background: -webkit-gradient(linear, 0 0, 0 100%, from(#fff), to(#eee));
                width:600px;
                height:600px;
                border-radius:300px;
                border:1px solid #aaa;
                box-shadow:0px 0px 10px #ddd;
            }

            #weibo_list{

                width:400px;
                height:600px;

                position:absolute;
                top:10px;
                left:650px;
            }
            .item{
                min-height:30px;
                width:300px;

                margin-bottom:5px;
            }
            .chou{
                border:1px solid #ddd;
                color:#404040;
                border:1px solid #ddd;
                background: -webkit-gradient(linear, 0 0, 0 100%, from(#fff), to(#F4F4F4));
                box-shadow:1px 1px 3px #ddd;
                width:180px;
                height:40px;
                font-size:25px;
            }
            .chou:hover,.add:hover{
                background: -webkit-gradient(linear, 0 0, 0 100%, from(#93CEF8), to(#4797CF));
                border:1px solid #3C88BB;
            }
            .add{
                border:1px solid #ddd;
                color:#404040;
                border:1px solid #ddd;
                background: -webkit-gradient(linear, 0 0, 0 100%, from(#fff), to(#F4F4F4));
                box-shadow:1px 1px 3px #ddd;
                width:50px;
                height:40px;
                margin-left:10px;
                font-size:25px;
            }
            #toweibo{
                border:1px solid #ddd;
                color:#404040;
                border:1px solid #ddd;
                background: -webkit-gradient(linear, 0 0, 0 100%, from(#fff), to(#F4F4F4));
                box-shadow:1px 1px 3px #ddd;
                width:30px;
                height:30px;
                margin-left:40px;
                vertical-align: 4px;
                font-size:15px;
            }
            #control{
                position:absolute;
                width:250px;
                height:100px;
                top:140px;
                left:90px;
                font-size:80px;
                font-family: 微软雅黑;
                cursor:pointer;
                color:#fff;
            }
            #choujiang {
                float:left;
                margin-left:100px;
                width:200px;
                padding-top:0px;
            }
            button{
                cursor:pointer;
            }

            #result{
                width:300px;
                height:300px;
                position:absolute;
                top:430px;
                left:650px;
                border:1px solid #ddd;
            }
            #result .hd{
                height:30px;
                font-size:24px;
                font-weight:bold;
                padding:5px;
                color:#999;
                border-bottom:1px solid #ddd;
                background: -webkit-gradient(linear, 0 0, 0 100%, from(#fff), to(#f7f7f7));
            }
            #result .bd{
                height:260px;
                overflow:auto;

            }
            .result-item{
                font-size:20px;
                font-weight:bold;
                color:#000;
                width:290px;
                overflow:hidden;
                height:40px;
                line-height:40px;
                padding-left:10px;
                background: -webkit-gradient(linear, 0 0, 0 100%, from(#fff), to(#f7f7f7));
            }
            .result-item.selected{
                color:#fff;
                background: -webkit-gradient(linear, 0 0, 0 100%, from(#93CEF8), to(#4797CF));
            }
            #title{
                text-align: center;
                font-size:50px;
                font-weight: bold;
                height:150px;
                line-height:60px;
            }
            #clock{
                position: absolute;
                top:250px;
                left:100px;
                font-size:50px;
            }
        </style>
        <script src="ks.js"></script>
    </head>
    <body>
        <div id="title">请在抽奖开始后在  新浪微博 <br/><em style="color:#ff6700;">@interACT设计论坛</em> ,即有机会抽奖!</div>
        <div id="circle_con">
            <div id="circle_big">

            </div>
            <div id="circle_small">
                <div id="control" data-state="end">开&nbsp;&nbsp;&nbsp;始</div>
                <div id="clock">00:00:00</div>
            </div>
            <div id="users"></div>
        </div>

        <div id="choujiang">
            <!--
            10点45分   马克杯5个，T恤5件，专业书籍5本，淘公仔5个   
17点   马克杯5个，T恤5件，专业书籍5本，U盘3个，shuffle 2台， itouch1台  
            -->
            <div class="item">
                <button class="chou" data-count="5" data-zuanzhu="淘宝网" data-jiangpin="徽章+马克杯+碳酸志">三等奖</button>
                <button class="add" data-count="1">+1</button>
            </div>
            <div class="item">
                <button class="chou" data-count="5" data-zuanzhu="淘宝网" data-jiangpin="徽章+T恤+名片夹">二等奖</button>
                <button class="add" data-count="1">+1</button>
            </div>
            <div class="item">
                <button class="chou" data-count="5" data-zuanzhu="淘宝网" data-jiangpin="碳酸志+笔记本+徽章">一等奖</button>
                <button class="add" data-count="1">+1</button>
            </div>
            <div class="item">
                <button class="chou" data-count="3" data-zuanzhu="淘宝网" data-jiangpin="U盘3个">U盘3个</button>
                <button class="add" data-count="1">+1</button>
            </div>
            <div class="item">
                <button class="chou" data-count="2" data-zuanzhu="淘宝网" data-jiangpin="shuffle 2台">nano 2台</button>
                <button class="add" data-count="1">+1</button>
            </div>
            <div class="item">
                <button class="chou" data-count="1" data-zuanzhu="淘宝网" data-jiangpin="itouch1台">itouch1台</button>
                <button class="add"  data-count="1">+1</button>
            </div>
            
            
            
           
            
        </div>
        <div id="result">
            <div class="hd">中奖名单(微博昵称)<button id="toweibo">W</button></div>
            <div class="bd" id="result-con">

            </div>
        </div>

        <script>
            var ws=[
                
            ];
            for(var i =0;i<100;i++){
                ws.push({
                    username:"user"+i,
                    userpic:"userpic"+i,
                    text:"text"+i,
                    source:"source"+i
                })
            }
            var mix=function(target,prototypes){
                for(var i in prototypes){
                    target[i]=prototypes[i];
                }
            }
            var circlePos=function(center,r,radian){
                var xy={
                    x:0,
                    y:0
                }
                xy.x=r*Math.sin(radian)+center.x
                xy.y=r*Math.cos(radian)+center.y
                
                return xy;
            }
            var ball=function(){
                this.x=0;
                this.y=0;
                this.v=1;
                this.r=50;
                this.radian=0;
                this.tarRadian=2*Math.PI;
                this.moveR=0;
                this.moveCenter={
                    x:300,
                    y:300
                }
            }
            ball.prototype={
                init:function(){
                    this.ele=document.createElement("div");
                    this.ele.className="user"
                    mix(this.ele.style,{
                        borderRadius:this.r+"px",
                        position:"absolute",
                        left:this.x-this.r+"px",
                        top:this.y-this.r+"px",
                        width:this.r*2+"px",
                        height:this.r*2+"px"
                    })
                    this.ele.style.background="url("+this.info.profile_image_url+")"
                    
                    document.getElementById("users").appendChild( this.ele)
                },
                move:function(){
                    if(this.v<0.0001) return;
                    this.v=(this.tarRadian-this.radian)*0.3
                    // this.r+=this.v;
                    this.radian+=this.v*0.1;
                    var xy=circlePos(this.moveCenter,this.moveR,this.radian);
                    this.ele.style.left=xy.x-this.r+"px";
                    this.ele.style.top=xy.y-this.r+"px";
                }
            }
            
          
            
            
            
            
            var Circle=function(){
                //小球初始位置
                var beginPos={
                    x:300,
                    y:600
                };
                var ballArray=[]
                var timer
                var ballR=50
                var circleR=250
                var moveCenter={
                    x:300,
                    y:300
                }
                return{
                    init:function(){
                      
                        this.initTimer();
                    },
                    addBall:function(info){
                        var b=new ball()
                        b.x=300
                        b.y=600
                        b.r=ballR
                        b.info=info;
                        b.moveR=circleR
                        b.moveCenter=moveCenter;
                        b.tarRadian=2*Math.PI-ballArray.length*Math.asin((ballR+2)/circleR)*2
                        b.init()
                        ballArray.push(b)
                    },
                    initTimer:function(){
                        timer=setInterval(function(){
                            for(var i=0;i<ballArray.length;i++){
                                ballArray[i].move();
                            }
                        },20)
                    },
                    clear:function(){
                        ballArray=[]
                    }
                }
            }();
            Circle.init();
            
          
            
            
           
            var S=KISSY,D=S.DOM,E=S.Event;
            var isBegin=false;
            var persons=[
                
            ]
            var results=[
                
            ]
            var timer;
            var usernames=[
            
            ]
            var begin=function(){
            Clock.reset();
                Clock.start();
                var xhr = new XMLHttpRequest();
                var url = "http://api.t.sina.com.cn/statuses/mentions.json?source=2348190958&count=1";
        
                xhr.open("POST",url, true);
                xhr.onreadystatechange =  function(e) {
                    if (xhr.readyState == 4) {
                        eval("var response="+this.responseText.replace(/\n/g,""))
                            response.length!=0&&( localStorage['last']=response[0].id);
                      //  localStorage['last']=13471428150
                        isBegin=true;
                        timer=setInterval(get,2000)
                        
                    }};
                xhr.send();
            }
            var idInArray=function(target,source){
                for(var i=0;i<source.length;i++){
                    if(source[i].id==target.id)
                        return true;
                }
                return false;
            }
            var get=function(){
                
                var xhr = new XMLHttpRequest();
                var url = "http://api.t.sina.com.cn/statuses/mentions.json?source=2348190958&count=200&since_id=" + localStorage['last'];
                xhr.open("POST",url, true);
                xhr.onreadystatechange =  function(e) {
                    if (xhr.readyState == 4) {
                        eval("var response="+this.responseText.replace(/\n/g,""))
                        response.length!=0&&( localStorage['last']=response[0].id);
                        for(var i=0;i<response.length;i++){
                            idInArray(response[i].user,persons)||persons.push(response[i].user)
                        }
                        console.log(persons)
                    }};
                xhr.send();
            }
            
            var end=function(){
                Clock.stop();
                clearInterval(timer);
                D.attr("#control","data-state","end")
                    D.html("#control","抽奖中")
            }
          
            E.on("#control","click",function(){
                if(D.attr(this,"data-state")=="end"){
                    begin();
                    D.attr(this,"data-state","begin")
                    D.html(this,"进行中")
                }else{
                    end();
                    D.attr(this,"data-state","end")
                    D.html(this,"抽奖中")
                }
            })
            var getRandom=function(count){
                var arr=[]
                for(var i=0;i<count;i++){
                    var index=Math.round(Math.random()*(persons.length-1))
                    arr.push(persons.splice(index,1)[0]);
                }
                
                return arr;
            }
            
            var clear=function(){
                var users=D.query(".user");
                Circle.clear();
                for(var i=0;i<users.length;i++){
                  
                    var anim=KISSY.Anim(users[i],{
                        opacity:"0"
                    },0.5,"easeNone",function(){
                        D.get("#users").removeChild(users[i])
                        
                    });
                    anim.run();
                }
            }
            var bindResult=function(){
            E.remove(".result-item","click");
                E.on(".result-item","click",function(){
                    D.toggleClass(this,"selected")
                    var items=D.query(".result-item");
                    usernames=[]
                    for(var i=0;i<items.length;i++){
                        if(D.hasClass(items[i],"selected")){
                            usernames.push(items[i].innerHTML)
                        }
                    }
                })
            }
            E.on(".chou","click",function(){
                clear();
                var count=this.getAttribute("data-count")
                result=getRandom(count);
                D.get("#toweibo").text="获得由 "+D.attr(this,"data-zuanzhu")+" 提供的 "+D.attr(this,"data-jiangpin")+"";
                D.get("#result-con").innerHTML=""
                for(var i in result){
                    var item=document.createElement("div");
                    item.className="result-item";
                    item.innerHTML=result[i].screen_name
                    D.get("#result-con").appendChild(item)
                }
                bindResult()
                setTimeout(function(){
                    try{
                        count--;
                        Circle.addBall(result[count])
                    }catch(e){
                        
                    }
                   
                    if(count!=0) setTimeout(arguments.callee,500);
                },500)
            })
            E.on(".add","click",function(){
                var count=this.getAttribute("data-count")
                
                result=result.concat(getRandom(count))
                var item=document.createElement("div");
                item.className="result-item";
                item.innerHTML=result[result.length-1].screen_name
                D.get("#result-con").appendChild(item)
                bindResult();
                setTimeout(function(){
                    //   count--;
                    Circle.addBall(result[result.length-1])
                    //   if(count!=0) setTimeout(arguments.callee,100);
                },100)
            })
          
            E.on("#toweibo","click",function(){
                var xhr = new XMLHttpRequest();
                var status="恭喜"
                
                for(var i=0;i<usernames.length;i++){
                    status+="@"+usernames[i]+" "
                }
                status+=this.text
                var url = "http://api.t.sina.com.cn/statuses/update.json?source=2348190958&status="+status.substr(0,139)
                xhr.open("POST",url, true);
                
                xhr.send();
            })
            
            
            
            var Clock=function(){
                var get=function(ele){
                    return document.getElementById(ele)
                },
                fillZero=function(num,length){
                    num=num.toString();
                    length=length||2
                    var str="";
                    for(var i=0,n=length-num.length;i<n;i++){
                        str+="0";
                    }
                    return str+num;
                }
               var count=0;
               var timer;
               var now;
                return {
                    flash:true,
                    max:100*60*60*5,
                    init:function(){
                        now=this;
                    },
                    start:function(){
                        this.go();
                        timer=setInterval(this.go,10)
                    },
                    stop:function(){
                        clearInterval(timer)
                    },
                    reset:function(){
                        count=0
                    },
                    go:function(){
                        if(count>=now.max) {
                            now.stop();
                            end();
                        }
                        count++
                        D.get("#clock").innerHTML=fillZero(parseInt(count/100/60))+":"+
                           fillZero(parseInt(count/100%60))+":"+
                            fillZero(parseInt(count%100))
                    }
                }
            }();
            Clock.init();
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            var testCount=1
            function sendTest(){
                var xhr = new XMLHttpRequest();
                var url = "http://api.t.sina.com.cn/statuses/update.json?source=2348190958&status= test"+(testCount++)+"@代码诗人天小祁";
        
                xhr.open("POST",url, true);
                xhr.onreadystatechange =  function(e) {
                    if (xhr.readyState == 4) {
                      
                    }};
                xhr.send();
            }
            function test(){
                for(var i=0;i<10;i++){
                    sendTest();
                }
            }
        
        </script>
    </body>
</html>
